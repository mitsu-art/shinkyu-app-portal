<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>船水式鍼灸臨床学習ナビゲーター</title>
    <meta name="robots" content="noindex">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { primary: '#B45309', accent: '#F59E0B', light: '#FFFDF6' },
                        rank: { technical: '#9D5D1D', eastern: '#0F172A', specialty: '#F59E0B', mental: '#CA8A04' }
                    },
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #FFFDF6; 
            overscroll-behavior-y: none;
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        
        .checklist-item { @apply bg-white p-3 border border-gray-200 rounded-lg transition-colors hover:bg-gray-50 cursor-pointer; }
        .checklist-item input[type="checkbox"] { 
            @apply accent-brand-primary w-5 h-5; 
        }
        
        .welcome-card { 
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            border: 4px solid #B45309; 
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .mobile-menu-overlay {
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .checklist-table th {
            white-space: nowrap; 
            min-width: 30px;
        }
        
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 箇条書きのスタイル強化 */
        ul.rich-list { list-style: none; padding-left: 0; }
        ul.rich-list li { position: relative; padding-left: 1.5em; margin-bottom: 0.5em; }
        ul.rich-list li::before { 
            content: "•"; 
            color: #B45309; 
            font-weight: bold; 
            position: absolute; 
            left: 0; 
            width: 1em; 
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-brand-light">

    <aside class="hidden lg:flex w-72 bg-white border-r border-gray-200 flex-none flex-col z-20 shadow-xl h-full">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-xl font-black text-brand-primary tracking-tight">船水式鍼灸 <span class="text-brand-accent">APP</span></h1>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">臨床学習ナビゲーター</p>
        </div>
        <div class="flex-1 overflow-y-auto p-3 custom-scroll sidebar-nav" id="sidebar-nav-pc"></div>
        <footer class="p-4 text-center text-xs text-gray-400 border-t">
            <p>User ID: <span id="user-id-pc">loading...</span></p>
        </footer>
    </aside>

    <header class="lg:hidden flex items-center justify-between p-4 bg-white border-b border-gray-200 z-30 shadow-sm shrink-0 safe-top">
        <div class="flex items-center">
            <h1 class="text-lg font-black text-brand-primary tracking-tight">船水式鍼灸 <span class="text-brand-accent">APP</span></h1>
        </div>
        <button id="mobile-menu-btn" class="text-brand-primary text-3xl focus:outline-none p-1">
            <i class="fa-solid fa-bars"></i>
        </button>
    </header>

    <div id="mobile-menu" class="fixed inset-0 z-50 transform translate-x-full transition-transform duration-300 lg:hidden flex">
        <div class="mobile-menu-overlay absolute inset-0" onclick="app.toggleMobileMenu()"></div>
        <div class="w-72 bg-white h-full shadow-2xl relative flex flex-col ml-auto">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-brand-light safe-top">
                <span class="font-bold text-brand-primary">メニュー</span>
                <button onclick="app.toggleMobileMenu()" class="text-3xl text-gray-500 p-2">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 custom-scroll sidebar-nav pb-10" id="sidebar-nav-mobile"></div>
            <footer class="p-4 text-center text-xs text-gray-400 border-t pb-8">
                <p>User ID: <span id="user-id-mobile">loading...</span></p>
            </footer>
        </div>
    </div>

    <main class="flex-1 relative bg-brand-light flex flex-col min-w-0 h-full overflow-hidden">
        <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 lg:p-12 pb-24 safe-bottom" id="main-scroll">
            <article id="module-content" class="max-w-4xl mx-auto pb-10">
                <!-- Module content will be injected here -->
            </article>
        </div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;
        const COLLECTION_PATH = `artifacts/${appId}/users/`;

        function getDocumentRef(userId, courseId) {
            if (!isAuthReady) return null;
            return doc(db, COLLECTION_PATH + userId + '/study_data', courseId);
        }

        async function saveStudyData(userId, courseId) {
            if (!isAuthReady) return;
            const docRef = getDocumentRef(userId, courseId);
            if (!docRef) return;

            const checklistContainer = document.getElementById('checklist-container');
            const notesTextarea = document.getElementById('notes');
            
            const studyData = { checklists: {}, notes: notesTextarea ? notesTextarea.value : "" };
            
            if (checklistContainer) {
                checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const step = checkbox.closest('.checklist-item').dataset.step;
                    studyData.checklists[step] = checkbox.checked;
                });
            }

            try {
                await setDoc(docRef, studyData, { merge: true });
                updateTotalScore();
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }

        function loadStudyData(userId, courseId) {
            if (!isAuthReady) return;
            const docRef = getDocumentRef(userId, courseId);
            if (!docRef) return;
            
            const checklistContainer = document.getElementById('checklist-container');
            const notesTextarea = document.getElementById('notes');
            
            if (checklistContainer) {
                checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false; 
                    checkbox.onchange = () => { saveStudyData(userId, courseId); updateTotalScore(); };
                });
            }
            if (notesTextarea) {
                notesTextarea.value = ""; 
                notesTextarea.oninput = () => saveStudyData(userId, courseId);
            }

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    if (loadedData.checklists && checklistContainer) {
                        checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            const step = checkbox.closest('.checklist-item').dataset.step;
                            if (loadedData.checklists[step] !== undefined) {
                                checkbox.checked = loadedData.checklists[step];
                            }
                        });
                    }
                    if (loadedData.notes !== undefined && notesTextarea) {
                        notesTextarea.value = loadedData.notes;
                    }
                    updateTotalScore();
                } else {
                    updateTotalScore();
                }
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }
        
        function updateTotalScore() {
            const checklistContainer = document.getElementById('checklist-container');
            if (!checklistContainer) return;
            
            const checkboxes = checklistContainer.querySelectorAll('input[type="checkbox"]');
            const totalSteps = checkboxes.length;
            const completedSteps = Array.from(checkboxes).filter(cb => cb.checked).length;

            const scoreText = `${completedSteps} / ${totalSteps} 完了`;
            const scorePercent = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
            
            const scoreElement = document.getElementById('total-score');
            if (scoreElement) scoreElement.textContent = scoreText;
            
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${scorePercent}%`;
            }
        }
        
        const app = {
            userId: null,
            modules: {
                'welcome_dashboard': {
                    title: 'ようこそ',
                    icon: 'fa-solid fa-house',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <div class="welcome-card p-6 md:p-12 text-brand-primary">
                            <div class="flex items-center space-x-3 mb-6">
                                <i class="fa-solid fa-wand-magic-sparkles text-4xl md:text-6xl text-brand-accent"></i>
                                <h2 class="text-2xl md:text-4xl font-black tracking-tight leading-tight">船水式鍼灸学 APP</h2>
                            </div>
                            <p class="text-base md:text-xl font-semibold mb-8">CMCの技術と哲学を統合した、美容・臨床学習ナビゲーターです。</p>
                            <h3 class="text-lg md:text-2xl font-bold mb-4 flex items-center text-rank-technical">
                                <i class="fa-regular fa-lightbulb mr-3 text-2xl md:text-3xl"></i> 船水式臨床の核
                            </h3>
                            <ul class="rich-list pl-2 space-y-3 text-sm md:text-lg mb-10">
                                <li><strong>TST（てい鍼術）:</strong> 刺さない鍼で<strong>気血を動かす</strong>。メンタルケア、難治性疾患に効果的です。</li>
                                <li><strong>コラーゲン戦略:</strong> 美容鍼の成功は、単なる刺鍼ではなく、40代以降に減少する<strong>コラーゲンとSMAS</strong>へのアプローチ、及び<strong>全身の陰陽調整</strong>にかかっています。</li>
                                <li><strong>三位一体治療:</strong> 局所治療と全身の経絡調整の統合、自律神経・内科的所見の改善を統合します。</li>
                            </ul>
                            <div class="p-4 bg-white rounded-lg shadow-md border border-gray-100">
                                <h4 class="font-bold text-lg md:text-xl mb-2 text-rank-specialty flex items-center"><i class="fa-solid fa-chart-simple mr-2"></i> 学習を始めましょう</h4>
                                <p>左上のメニュー（スマホ）または左側のサイドバー（PC）から学習モジュールを選択してください。</p>
                            </div>
                        </div>
                    `
                },
                'tst_basis': {
                    title: 'TST（てい鍼）の基礎',
                    icon: 'fa-solid fa-wand-magic-sparkles',
                    color: 'eastern',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-4 md:mb-6">てい鍼（TST）の基本理論と術式</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-eastern rounded mb-6 text-sm md:text-base">
                            <h4 class="font-bold text-base md:text-lg text-rank-eastern mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> TST（TAKAHIRO STYLE TECHNIQUE）とは</h4>
                            <p>てい鍼（錕鍼：刺さない鍼）を用いた独自の技術です。目的は<strong>「気血を動かすこと」</strong>。刺激はごく少なく、経絡・経穴に触れる程度で行います。痛みに敏感な患者、小児、高齢者、そして特に<strong>メンタルケア</strong>に高い効果が期待されます。</p>
                            
                            <h4 class="font-bold text-base md:text-lg text-rank-eastern mt-6 mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> 気の考え方</h4>
                            <ul class="rich-list pl-2 space-y-2">
                                <li><strong>気と水:</strong> 水に関係する経穴（合谷、太渓、尺沢など）は気と関係が深い。</li>
                                <li><strong>経穴:</strong> 気が骨に当たり吹き出すところ（骨間部、脈の拍動部などに多い）。</li>
                                <li><strong>気の流れ（コマの理論）:</strong> 気の流れはコマに例えられます。スムーズに回っている（流れている）時は安定して静止しているように見えます。流れが滞ると安定性を失います。治療は気の流れが止まらないようにすることです。</li>
                                <li><strong>気の巡り:</strong> 気はスパイラル（渦巻き状）で巡っています。</li>
                            </ul>

                            <h4 class="font-bold text-base md:text-lg text-rank-eastern mt-6 mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> 学ぶ姿勢（守破離と真行草）</h4>
                            <ul class="rich-list pl-2 space-y-2">
                                <li><strong>守破離:</strong>
                                    <br>・<strong>守:</strong> 純粋に真似る。
                                    <br>・<strong>破:</strong> 型を創意工夫する。破壊ではなく一段上がる事を目指す。
                                    <br>・<strong>離:</strong> 自分とはなにか。自分を作る。道を作る。
                                </li>
                                <li><strong>真行草:</strong>
                                    <br>・<strong>真:</strong> 忠実に真似をする。すべての動作の意味を知る。
                                    <br>・<strong>行:</strong> 柔軟な理解、姿勢。状況に応じての変化。
                                    <br>・<strong>草:</strong> 最も核心に近いもの。全てを削ぎ落とした中心。
                                </li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-eastern border-b border-gray-200 pb-2 mb-4">TST 術式分類（補法と瀉法）</h3>
                        <div class="overflow-x-auto w-full mb-6">
                            <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg whitespace-nowrap md:whitespace-normal text-xs md:text-sm">
                                <thead>
                                    <tr class="bg-rank-eastern/10 font-bold">
                                        <th class="p-2 md:p-3 border">補瀉</th><th class="p-2 md:p-3 border">分類</th><th class="p-2 md:p-3 border">術式（例）</th><th class="p-2 md:p-3 border">目的/イメージ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-2 md:p-3 border text-green-700 font-semibold align-top" rowspan="4"><b>補法</b><br><span class="text-xs text-gray-500">気を注ぐ</span></td>
                                        <td class="p-2 md:p-3 border align-top" rowspan="2">基本</td>
                                        <td class="p-2 md:p-3 border"><strong>波紋術</strong>、片手波紋術</td>
                                        <td class="p-2 md:p-3 border">気が広がり、垂直に伝わる。水面に石を投げるイメージ。${isAuthReady ? '' : ''}</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border"><strong>花火術</strong>、水琴窟術</td>
                                        <td class="p-2 md:p-3 border">気を注ぎ、高める。臍や頭部など中心的な部位に用いる。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border align-top" rowspan="2">応用</td>
                                        <td class="p-2 md:p-3 border">五月雨術</td>
                                        <td class="p-2 md:p-3 border">優しくトントンと気を注ぐ。お母さんが背中を叩くイメージ。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border">稜線</td>
                                        <td class="p-2 md:p-3 border">二本のてい鍼で深いところに気を通す（例: 頸部の深い筋）。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border text-red-700 font-semibold align-top" rowspan="3"><b>瀉法</b><br><span class="text-xs text-gray-500">気を流す</span></td>
                                        <td class="p-2 md:p-3 border align-top" rowspan="3">基本/応用</td>
                                        <td class="p-2 md:p-3 border"><strong>さざなみ術</strong>、両手さざなみ術</td>
                                        <td class="p-2 md:p-3 border">経絡や体表面に気を流す。優しく撫でるイメージ。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border">霰（あられ）術</td>
                                        <td class="p-2 md:p-3 border">五月雨術より弱い刺激。軽度の気の停滞を流す。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-2 md:p-3 border">雷（いかづち）</td>
                                        <td class="p-2 md:p-3 border">深部に気が伝わるような強い瀉法（例: 頚部の深部）。</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `
                },
                'basic_pulse': {
                    title: '低周波治療の基礎',
                    icon: 'fa-solid fa-bolt',
                    color: 'technical',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-4 md:mb-6">低周波鍼治療の基礎と設定</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-brand-accent rounded mb-6 text-sm md:text-base">
                            <h4 class="font-bold text-base md:text-lg text-brand-accent mb-2 flex items-center"><i class="fa-solid fa-circle-exclamation mr-2"></i> 凝り・痛みの発生プロセス</h4>
                            <p class="mb-2">筋肉の緊張や自律神経の乱れにより血管が圧迫されて血流が悪化します。その結果、以下の悪循環が生まれます。</p>
                            <ol class="list-decimal pl-5 space-y-1 mb-2">
                                <li>血管圧迫・血流悪化</li>
                                <li>酸素・栄養素が不足</li>
                                <li>老廃物（疲労物質）が蓄積</li>
                                <li>凝りや痛みが発生</li>
                            </ol>
                            <p>低周波治療の目的は、<strong>血行不良改善、筋肉のこりの緩和、痛みの緩和</strong>です。${isAuthReady ? '' : ''}</p>

                            <h4 class="font-bold text-lg text-brand-accent mt-6 mb-2 flex items-center"><i class="fa-solid fa-chart-line mr-2"></i> 筋ポンプ作用（血流改善の鍵）</h4>
                            <p>骨格筋内循環の促進を目的とし、筋肉の収縮後充血、繰り返す筋収縮による<strong>筋ポンプ作用</strong>が最も大切です。これにより静脈血を心臓へ送り返し、新しい血液（酸素・栄養）を呼び込みます。</p>
                        </div>

                        <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">周波数・パルス幅の使い分け</h3>
                        <div class="overflow-x-auto w-full mb-6">
                            <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg whitespace-nowrap md:whitespace-normal text-xs md:text-sm">
                                <thead>
                                    <tr class="bg-gray-100 font-bold">
                                        <th class="p-3 border">項目</th>
                                        <th class="p-3 border text-center"><b>一次痛・急性期</b><br><span class="text-xs font-normal">損傷直後/鎮痛/腫脹</span></th>
                                        <th class="p-3 border text-center"><b>二次痛・慢性期</b><br><span class="text-xs font-normal">順応後/筋緩和/血流</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-3 border font-semibold">周波数</td>
                                        <td class="p-3 border text-center"><strong>80〜125Hz</strong><br>(高頻度)</td>
                                        <td class="p-3 border text-center"><strong>1〜30Hz</strong><br>(低頻度)</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3 border font-semibold">パルス幅</td>
                                        <td class="p-3 border text-center">100µsec以下</td>
                                        <td class="p-3 border text-center">100µsec以上<br>(深部は高めに)</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3 border font-semibold">通電時間</td>
                                        <td class="p-3 border text-center">10分以上</td>
                                        <td class="p-3 border text-center">20〜30分以上</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3 border font-semibold">刺激強度</td>
                                        <td class="p-3 border text-center">反応閾値前後まで</td>
                                        <td class="p-3 border text-center">反応閾値以下<br>(弱め)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <h4 class="font-bold text-base md:text-lg text-brand-accent mb-2">周波数別作用の目安</h4>
                        <ul class="rich-list pl-2 space-y-2 text-sm md:text-base">
                            <li><strong>1〜3Hz (単収縮):</strong> 筋肉がトントンと動く。筋緊張緩和、血流改善に用いる。通電は15分程度。</li>
                            <li><strong>30〜60Hz (強縮):</strong> 筋肉がギュッと収縮し続ける。筋疲労軽減、腱炎などに用いる。通電は15分程度。</li>
                            <li><strong>100〜120Hz (収縮なし):</strong> 筋収縮が起こらない。通電した局所に刺激を感じる。関節痛、局所鎮痛、腫脹の軽減に用いる。通電は15分程度。</li>
                            <li><strong>急性期の注意:</strong> 筋繊維断裂の恐れがあるため、筋ポンプを起こすような低頻度（1Hz〜10Hz）は避け、高頻度（収縮させない）を使用する。</li>
                        </ul>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-8 mb-4">通電に関する注意事項・禁忌</h3>
                        <ul class="rich-list pl-2 space-y-2 text-sm">
                            <li>電圧にH・Lがある場合はLを選択する。</li>
                            <li>クリップは皮膚に近い部分で行う。コードは水平になるように工夫し、下に垂らさない（重力で抜けるのを防ぐ）。</li>
                            <li>電流の上昇はパルス波発信のときに行うこと。</li>
                            <li>通電後無反応であっても遅延して起こる可能性もあるため、少し待つこと。</li>
                            <li>刺鍼部位の近位に手を触れて収縮を確認すること。</li>
                            <li>ペースメーカー着用者には絶対に使用しない。</li>
                            <li>体内金属がある場合は、金属に近い場所は使用しない。</li>
                        </ul>
                    `
                },
                'fem_care': {
                    title: '婦人科・フェムケアプロトコル',
                    icon: 'fa-solid fa-person-dress',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-6">婦人科疾患の東洋医学的治療</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-specialty rounded mb-6 text-sm md:text-base">
                            <h4 class="font-bold text-base md:text-lg text-rank-specialty mb-2 flex items-center"><i class="fa-solid fa-person mr-2"></i> 骨盤底筋群とインナーユニット</h4>
                            <p class="mb-2">骨盤底筋群は、膀胱・子宮・直腸などの臓器を正しい位置に保つ役割、腹圧の調整、排泄の制御（緊張・弛緩）を担っています。</p>
                            <p>横隔膜・腹横筋・多裂筋と共に<strong>インナーユニット</strong>を形成し、体幹の安定に不可欠です。${isAuthReady ? '' : ''}</p>
                            
                            <h4 class="font-bold text-base md:text-lg text-rank-specialty mt-4 mb-2 flex items-center"><i class="fa-solid fa-circle-exclamation mr-2"></i> 衰える原因</h4>
                            <ul class="rich-list pl-2 space-y-1">
                                <li>加齢（女性ホルモンの減少）</li>
                                <li>運動不足、肥満</li>
                                <li>妊娠・出産</li>
                                <li>便秘（排便時のいきみ）</li>
                            </ul>
                        </div>

                        <h3 class="text-xl font-bold text-rank-specialty border-b border-gray-200 pb-2 mb-4">治療プロトコル（経絡・経穴）</h3>
                        
                        <h4 class="font-bold text-base mt-2 mb-2">共通穴（基本刺鍼：3mm / 10分置鍼）</h4>
                        <ul class="rich-list pl-2 space-y-1 text-sm mb-4">
                            <li><strong>任脈系:</strong> 石門、気海、関元（妊娠脈であり、妊娠エネルギーが流れる）。</li>
                            <li><strong>子宮周囲:</strong> 子宮、帰来（子宮の栄養血管上）。<br>※低周波治療をする場合は1cm刺鍼。<strong>3Hzで15分間</strong>。生理痛がひどい場合は<strong>100Hzで15分間</strong>。</li>
                            <li><strong>陰経の要穴:</strong> 太渓（腎経原穴・生命力）、三陰交（3つの陰経の交わる冷える場所）、血海（血を蓄え循環）。</li>
                            <li><strong>背部:</strong> 腎兪（腎気を満たす・腰痛治療）、次醪（精子の活動能力UP）。</li>
                        </ul>
                        
                        <h3 class="text-xl font-bold text-rank-specialty border-b border-gray-200 pb-2 mt-8 mb-4">タイプ別治療方針</h3>
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg whitespace-nowrap md:whitespace-normal text-xs md:text-sm">
                                <thead>
                                    <tr class="bg-rank-specialty/10 font-bold">
                                        <th class="p-3 border">タイプ</th>
                                        <th class="p-3 border">病態</th>
                                        <th class="p-3 border">治療穴・手技</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-3 border font-semibold">気滞瘀血タイプ</td>
                                        <td class="p-3 border">気の巡り・血の巡りが悪く瘀血ができる。冷えが強い。月経痛が強く、塊が出ると楽になる。</td>
                                        <td class="p-3 border"><strong>血海</strong>・<strong>三陰交</strong>（陰陵泉）にマイクロカレント。<br><strong>気海</strong>・<strong>曲泉</strong>。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3 border font-semibold">熱がこもりやすタイプ</td>
                                        <td class="p-3 border">陰虚熱。月経時ホットフラッシュ、寝汗、イライラ（自律神経の乱れ）。</td>
                                        <td class="p-3 border"><strong>太衝</strong>・<strong>蠡溝</strong>にマイクロカレント（肝の調整）。<br><strong>三陰交</strong>。</td>
                                    </tr>
                                    <tr>
                                        <td class="p-3 border font-semibold">冷えが強いタイプ</td>
                                        <td class="p-3 border">肝虚・腎虚。下腹部の冷え（腎陽虚）が強く、下肢のむくみを伴う。</td>
                                        <td class="p-3 border"><strong>中極</strong>・<strong>関元</strong>・<strong>三陰交</strong>に灸。<br>地機、水道。復溜に置鍼。</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `
                },
                'autonomic_nervous_system': {
                    title: '自律神経治療プロトコル',
                    icon: 'fa-solid fa-brain',
                    color: 'mental',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-6">自律神経失調症と陰陽調整</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-mental rounded mb-6 text-sm md:text-base">
                            <h4 class="font-bold text-base md:text-lg text-rank-mental mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> 自律神経の役割と病態</h4>
                            <p>自律神経（交感/副交感）は、日中は交感神経が優位、夜間は副交感神経が優位となる理想的なリズムで臓器をコントロールします。このバランスが崩れると、だるさ、頭痛、動悸、冷え、しびれなど全身に様々な不調（自律神経失調症）が現れます。${isAuthReady ? '' : ''}</p>
                            
                            <h4 class="font-bold text-lg text-rank-mental mt-6 mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> 陰陽失調タイプ（病態生理）</h4>
                            <div class="grid md:grid-cols-2 gap-4 mt-4">
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <strong class="text-blue-700 block mb-2">陰気が多すぎるタイプ</strong>
                                    <ul class="rich-list pl-2 text-sm">
                                        <li>動きや発言が鈍り、心身ともに冷えて停滞しやすい。</li>
                                        <li>優柔不断、依存体質、消極的。</li>
                                        <li>泣き上戸、落ち込みやすい、心配症。</li>
                                        <li>冷え性、低血圧、貧血気味、寝起きが悪い。</li>
                                    </ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-gray-200">
                                    <strong class="text-red-700 block mb-2">陽気が多すぎるタイプ</strong>
                                    <ul class="rich-list pl-2 text-sm">
                                        <li>体温が上昇し、頭に血がのぼりイライラしがち。</li>
                                        <li>頑固で自己中心的、協調性がない。</li>
                                        <li>暴力的になる、快楽を追求する。</li>
                                        <li>口数が多く早口。心拍数が高い、高血圧、のぼせやすい。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-mental border-b border-gray-200 pb-2 mb-4">治療プロトコル（QOL・精神安定）</h3>
                        <p class="text-sm mb-4">陰陽の調整（寒い・暑いの調整）を基本とします。パルス療法は弱刺激で行います（ただし筋緊張が強く出るタイプは通常の筋パルスが良い）。</p>
                        
                        <h4 class="font-bold text-base mt-2 mb-2">主要経穴（毫鍼・置鍼）</h4>
                        <ul class="rich-list pl-2 space-y-1 text-sm md:text-base">
                            <li><strong>腹部（陰陽調整/脾胃）:</strong> 中脘・関元・天枢</li>
                            <li><strong>自律神経調節:</strong> 内関（心包）、外関（三焦系/体温・免疫力）</li>
                            <li><strong>腎（生命力/体温）:</strong> 太渓、背部腎兪・志室</li>
                            <li><strong>背部/頸部（陽気調整）:</strong> 膀胱経（膈兪・肝兪・脾兪腎兪）、天柱・風池（頭部血流を高め視床下部を調整）</li>
                        </ul>
                         <h4 class="font-bold text-base mt-4 mb-2">TST応用（てい鍼/刺さない鍼）</h4>
                        <ul class="rich-list pl-2 space-y-1 text-sm">
                            <li><strong>胸部:</strong> 膻中（即刺即抜）で胸郭の緊張を緩め、呼吸を深くする。</li>
                            <li><strong>頭部:</strong> 頭部散鍼（百会、額会、冠状縫合）で頭部血流を改善。額のつまみ触察後、20Hzパルス。</li>
                            <li><strong>耳鍼:</strong> 神門（精神安定/痛み）、BFA（バトルフィールド鍼：視床、帯状回など脳中枢に作用）。${isAuthReady ? '' : ''}</li>
                        </ul>
                    `
                },
                'knee_shoulder_trunk': {
                    title: '膝・体幹・肩の専門治療',
                    icon: 'fa-solid fa-heart-pulse',
                    color: 'technical',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-6">膝関節疾患の治療プロトコル</h2>
                        
                        <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">1. 鵞足炎（Pes Anserine Bursitis）</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm md:text-base">
                            <p><strong>痛みの部位:</strong> 膝内側。鵞足部（縫工筋・薄筋・半腱様筋の腱付着部）。<br><strong>原因:</strong> オーバーユース（長距離走など）による膝の屈曲・股関節内転動作の繰り返し。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-base mt-2">鍼治療プロトコル</h4>
                            <ul class="rich-list pl-2">
                                <li><strong>主刺鍼部位:</strong> <strong>薄筋</strong>（神経・血管網が多く、最も痛みを及ぼしやすい）</li>
                                <li><strong>周波数:</strong> 通常 5Hz / 15分。痛みが強い場合は 100Hz（急性期の鎮痛）。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">2. 腸脛靭帯炎（ITBS / Runner's Knee）</h3>
                         <div class="bg-brand-light p-4 rounded mb-4 text-sm md:text-base">
                            <p><strong>痛みの部位:</strong> 膝外側面。大腿骨外側上顆付近。<br><strong>原因:</strong> 腸脛靭帯が大腿骨外側上顆を擦過することで炎症が起こる。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-base mt-2">鍼治療プロトコル</h4>
                            <ul class="rich-list pl-2">
                                <li><strong>主刺鍼部位:</strong> 膝付近の<strong>腸脛靭帯外側縁</strong>、または<strong>大腿筋膜張筋</strong>。</li>
                                <li><strong>補助穴:</strong> 長腓骨筋部位 (陽陵泉、陽交など) に刺鍼すると更に効果的。</li>
                                <li><strong>遠隔治療（陽経を動かす）:</strong> <strong>条口</strong>〜<strong>承山</strong>への透刺（条山治療）。2寸3〜5番鍼で2cm以上刺入し、陽経の気血循環を促進。</li>
                            </ul>
                        </div>

                        <h2 class="text-2xl font-black text-brand-primary mt-10 mb-6">体幹・肩の専門低周波パルス</h2>

                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">1. 多裂筋/腰方形筋低周波通電療法</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">多裂筋（固定性/中心部の痛み）</h4>
                            <ul class="rich-list pl-2 mb-2">
                                <li><strong>特徴:</strong> 第3腰椎以下で脊柱起立筋より占める割合が多く、脊椎の安定に重要。腰痛患者の約80%に萎縮。腰の中心の痛み。</li>
                                <li><strong>目的:</strong> 筋収縮させて力を戻したい時：<strong>5Hz〜8Hz</strong>。痛みを取る：<strong>1Hz〜2Hz</strong>で微弱電流。急性期は50〜100Hz。</li>
                                <li><strong>刺鍼:</strong> L4棘突起すぐ横を押圧し、脚挙上や力で硬くなる部位を確認。</li>
                            </ul>
                            <h4 class="font-bold text-base mt-2 mb-2">腰方形筋（深部の刺すような痛み）</h4>
                            <ul class="rich-list pl-2">
                                <li><strong>特徴:</strong> 12肋骨に付着し呼吸と関与。奥深くに刺すような痛み、寝返り時痛。</li>
                                <li><strong>刺鍼部位:</strong> 腰椎棘突起の外方3〜5cmのエリア。<strong>垂直に40mm/16号で5〜10mm刺入</strong>。</li>
                                <li><strong>注意:</strong> 大腰筋刺鍼時は深さ6cm（L3・4横突起に直刺）。<strong>5cmで腎臓に到達するリスク</strong>があるため厳重に注意。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">2. 頸部・斜角筋パルス鍼</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">斜角筋パルス（TOS/スマホ姿勢）</h4>
                            <ul class="rich-list pl-2 mb-2">
                                <li><strong>部位:</strong> 胸鎖乳突筋（SCM）後縁。<strong>喉頭隆起の高さ以下は気胸リスクあり</strong>。SCM後縁に縦に2本を皮膚に垂直に刺鍼（深さ1cm）。</li>
                                <li><strong>目的/周波数:</strong> <strong>1Hz〜2Hz</strong> / 15分。強いしびれが出ない程度のボリューム。SCMの収縮は避ける。</li>
                            </ul>
                            <h4 class="font-bold text-base mt-2 mb-2">横隔神経刺鍼（呼吸調整）</h4>
                            <ul class="rich-list pl-2">
                                <li><strong>部位:</strong> 喉頭隆起ライン。SCM鎖骨頭を指で押し下げて刺鍼（1cm以下）。針先は<strong>前斜角筋</strong>に触れるように。</li>
                                <li><strong>注意:</strong> 深く指すと腕神経叢に当たり不快なピリピリ感が出る。横隔膜の運動を支配する神経であり、呼吸の改善に直結。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">3. 肩の専門治療（ローテータカフ・巻き肩）</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">棘上筋/肩甲上神経パルス（外転障害）</h4>
                            <ul class="rich-list pl-2 mb-2">
                                <li><strong>筋パルス:</strong> 棘上筋に水平に2穴刺入（1cm）。1〜3Hzで筋収縮をしっかり確認。</li>
                                <li><strong>神経パルス:</strong> <strong>肩甲上神経</strong>（肩甲切痕、棘下切痕）に1Hz / 15分。筋が心地よく動くレベル。</li>
                                <li><strong>肩甲挙筋:</strong> 乳様突起付近やC4横突起付近。上角付近は<strong>肺尖部</strong>に注意（てい鍼・散鍼が有効）。</li>
                            </ul>
                             <h4 class="font-bold text-base mt-2 mb-2">巻き肩/大円筋/小円筋（結髪結帯障害）</h4>
                             <ul class="rich-list pl-2">
                                <li><strong>巻き肩原因筋:</strong> 肩甲挙筋、僧帽筋上部線維、大胸筋、<strong>大円筋</strong>。</li>
                                <li><strong>大円筋刺鍼:</strong> 肩甲骨下角付近で内旋し収縮する部位に直刺1〜2cm。</li>
                                <li><strong>小円筋刺鍼:</strong> 肩甲骨に沿って刺鍼し、大結節付近に直刺（深さ1〜2cm）。小円筋は<strong>腋窩神経</strong>支配。${isAuthReady ? '' : ''}</li>
                                 <li><strong>QLS（四辺形間隙）:</strong> 小円筋、大円筋、上腕三頭筋長頭、上腕骨で構成され、腋窩神経/後上腕回旋動脈が通る。過緊張でしびれ・痛みが発生。</li>
                            </ul>
                        </div>
                    `
                },
                'keiraku_chiryo': {
                    title: '東洋医学・経絡治療の基本',
                    icon: 'fa-solid fa-leaf',
                    color: 'eastern',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-6">『増補改訂版 日本鍼灸医学』の核心</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-eastern rounded mb-6 text-sm md:text-base">
                            <p>経絡治療は、古典理論に基づき、すべての疾病を<strong>経絡の虚実状態</strong>として把握し、それを鍼灸を用いて調整（補瀉）する<strong>随証療法</strong>です。病気の始まりは<strong>五臓の精気の虚</strong>からと考えます。</p>
                            <h4 class="font-bold text-base md:text-lg text-rank-eastern mt-2 mb-2 flex items-center"><i class="fa-solid fa-caret-right mr-2"></i> 診断の基本</h4>
                            <ul class="rich-list pl-2 space-y-1">
                                <li><strong>四診法:</strong> 望診、聞診、問診、切診（脈診、腹診、切経）。</li>
                                <li><strong>最重要: 切診（特に脈診）</strong>。六部定位脈診により、臓腑経絡における気血津液の虚実寒熱を診察します。</li>
                            </ul>
                        </div>
                        <h3 class="text-lg md:text-xl font-bold text-rank-eastern border-b border-gray-200 pb-2 mb-4">五行説と五臓の関連（相生関係）</h3>
                        <div class="overflow-x-auto w-full">
                            <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg whitespace-nowrap md:whitespace-normal text-xs md:text-sm">
                                <thead>
                                    <tr class="bg-rank-eastern/10 font-bold">
                                        <th class="p-3 border">五行</th>
                                        <th class="p-3 border">五臓（母）</th>
                                        <th class="p-3 border">五臓（子）</th>
                                        <th class="p-3 border">関係性</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="p-3 border">水</td><td class="p-3 border">腎（精を蔵す）</td><td class="p-3 border">肝（血を潤す）</td><td class="p-3 border">腎は肝を生ず</td></tr>
                                    <tr><td class="p-3 border">木</td><td class="p-3 border">肝（血を蔵す）</td><td class="p-3 border">心（心の活動の元）</td><td class="p-3 border">肝は心を生ず</td></tr>
                                    <tr><td class="p-3 border">火</td><td class="p-3 border">心（陽気を発揮）</td><td class="p-3 border">脾（陽気を受け働く）</td><td class="p-3 border">心は脾を生ず</td></tr>
                                    <tr><td class="p-3 border">土</td><td class="p-3 border">脾（気血津液を生成）</td><td class="p-3 border">肺（肺気の循環を助ける）</td><td class="p-3 border">脾は肺を生ず</td></tr>
                                    <tr><td class="p-3 border">金</td><td class="p-3 border">肺（気を全身に送る）</td><td class="p-3 border">腎（津液を全身に巡らせる）</td><td class="p-3 border">肺は腎を生ず</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">※治療では、この相生関係に基づき、虚している経（母）の補うべき穴（子穴）を選びます。</p>
                    `
                },
                'cosmetic_acupuncture': {
                    title: '船水式美容鍼チェックリスト',
                    icon: 'fa-solid fa-clipboard-check',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <h2 class="text-xl md:text-2xl font-black text-brand-primary mb-6">船水式美容鍼（基本）実技チェックリスト</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-specialty rounded mb-6 text-sm">
                            <p><strong>コースID:</strong> funamizu_biyoushin</p>
                            <h4 class="font-bold text-base md:text-lg text-rank-specialty mb-2 flex items-center"><i class="fa-solid fa-list-check mr-2"></i> 進捗状況</h4>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-base md:text-lg font-bold text-brand-primary">完了ステップ:</span>
                                <span id="total-score" class="text-xl md:text-2xl font-black text-brand-accent">0 / 22 完了</span>
                            </div>
                            <div class="progress-bar-container w-full h-2 bg-gray-200 rounded-full">
                                <div id="progress-bar" class="h-full bg-rank-specialty rounded-full transition-all duration-400" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div id="checklist-container" class="mt-6">
                            <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-4 mb-4">I. 基本手技・解剖・安全性チェック</h3>
                            <div class="checklist-item" data-step="p1_prep_talk">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>1. 術前説明とコラーゲン知識</span></label>
                                <div class="step-detail text-sm text-gray-500 pl-8 mt-1">コラーゲンが40代以降減少すること、ターンオーバー（45日）の説明。</div>
                            </div>
                            <div class="checklist-item" data-step="p2_base_clean">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>2. 消毒、前後揉捻、皮膚触察</span></label>
                            </div>
                            <div class="checklist-item" data-step="p3_hishin_safety">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>3. 基本刺鍼（23本）の正確性と安全性</span></label>
                                <div class="step-detail text-sm text-gray-500 pl-8 mt-1">切皮痛がなく、正しい角度・押手で。</div>
                            </div>
                            <div class="checklist-item" data-step="p4_artery_nerve">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>4. 顔面動脈・神経走行の理解と回避</span></label>
                            </div>
                            <div class="checklist-item" data-step="p5_basic_safety_time">
                                <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>5. 時間管理と安心感（5分以内）</span></label>
                            </div>
                            
                            <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">II. 部位別・解剖チェック</h3>
                            <div class="checklist-item" data-step="p6_tst_facecare"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>6. TSTを用いた刺鍼前ケア実施</span></label></div>
                            <div class="checklist-item" data-step="p7_part_eye_lig"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>7. 目元（眼輪筋）とリガメントへのアプローチ</span></label></div>
                            <div class="checklist-item" data-step="p8_part_nose"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>8. 鼻へのアプローチと効果</span></label></div>
                            <div class="checklist-item" data-step="p9_part_mouth_smas"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>9. 口元・法令線（SMAS）へのアプローチ</span></label></div>
                            <div class="checklist-item" data-step="p10_part_cheek_jaw"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>10. 頬・輪郭へのアプローチ</span></label></div>
                            <div class="checklist-item" data-step="p11_part_lymph"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>11. リンパ・血流の促進</span></label></div>
                            
                            <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">III. 症状別チェック</h3>
                            <div class="checklist-item" data-step="p12_symptom_lift"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>12. たるみ・リフトアップの改善確認</span></label></div>
                            <div class="checklist-item" data-step="p13_symptom_circulation"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>13. 血色・くすみ・疲労感の改善確認</span></label></div>
                            <div class="checklist-item" data-step="p14_symptom_skin_oath"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>14. ニキビ・肌荒れへのアプローチ（胃熱・脾虚など）</span></label></div>
                            <div class="checklist-item" data-step="p15_symptom_tension"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>15. 口元の緊張・歪みの改善</span></label></div>
                            <div class="checklist-item" data-step="p16_body_balance_body"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>16. 全身の本治法の実施（太渓、三陰交など）</span></label></div>
                            <div class="checklist-item" data-step="p17_body_balance_oath"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>17. 脈診/腹診による全身所見の確認</span></label></div>
                            
                            <h3 class="text-lg md:text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">IV. 応用・口頭試問</h3>
                            <div class="checklist-item" data-step="p18_advanced_pulse"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>18. 顔面神経パルス（応用）の実施</span></label></div>
                            <div class="checklist-item" data-step="p19_advanced_tst"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>19. TST術式の選択と実施</span></label></div>
                            <div class="checklist-item" data-step="p20_advanced_kouto"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>20. 口頭試問への対応</span></label></div>
                            <div class="checklist-item" data-step="p21_final_check"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>21. 全体的な流れとスムーズさ</span></label></div>
                            <div class="checklist-item" data-step="p22_patient_care"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox"><span>22. 患者への配慮とコミュニケーション</span></label></div>
                        </div>
                        
                        <section class="note-section mt-8">
                            <h3 class="text-lg md:text-xl font-bold text-brand-primary mb-4">練習メモ・気づき</h3>
                            <textarea id="notes" class="w-full p-3 border border-gray-300 rounded-lg min-h-[150px]" placeholder="今日の練習で気づいたことなどを記録しましょう。"></textarea>
                        </section>
                    `
                },
            },
            currentModule: 'welcome_dashboard', 
            
            init() {
                this.renderSidebar();
                this.loadModule(this.currentModule);
            },
            
            toggleMobileMenu() {
                const menu = document.getElementById('mobile-menu');
                if (menu.classList.contains('translate-x-full')) {
                    menu.classList.remove('translate-x-full');
                } else {
                    menu.classList.add('translate-x-full');
                }
            },
            
            renderSidebar() {
                const pcContainer = document.getElementById('sidebar-nav-pc');
                const mobileContainer = document.getElementById('sidebar-nav-mobile');
                
                if (pcContainer) pcContainer.innerHTML = '';
                if (mobileContainer) mobileContainer.innerHTML = '';
                
                const createSidebarItem = (id, module) => {
                    const btn = document.createElement('button');
                    btn.id = `nav-${id}`;
                    btn.className = `w-full text-left px-4 py-3 mb-1 flex items-center transition-all duration-200 border-l-4 border-transparent text-gray-700 hover:bg-gray-100 hover:border-rank-${module.color}`;
                    btn.innerHTML = `<i class="${module.icon} text-lg mr-3 text-rank-${module.color}"></i><span class="font-medium text-sm">${module.title}</span>`;
                    
                    const btnClone = btn.cloneNode(true);
                    btn.onclick = () => app.loadModule(id);
                    btnClone.onclick = () => {
                        app.loadModule(id);
                        app.toggleMobileMenu();
                    };
                    return { pcBtn: btn, mobileBtn: btnClone };
                };

                for (const id in this.modules) {
                    const module = app.modules[id]; 
                    const { pcBtn, mobileBtn } = createSidebarItem(id, module);
                    if (pcContainer) pcContainer.appendChild(pcBtn);
                    if (mobileContainer) mobileContainer.appendChild(mobileBtn);
                }
                
                const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                if (mobileMenuBtn) {
                    mobileMenuBtn.onclick = this.toggleMobileMenu;
                }
            },
            
            loadModule(id) {
                app.currentModule = id;
                const module = app.modules[id];
                const contentArea = document.getElementById('module-content');
                
                const updateActiveState = (containerId) => {
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    container.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('bg-gray-200', 'font-bold');
                        btn.className = btn.className.replace(/border-rank-[a-z]+/, 'border-transparent');
                    });
                    // Note: Simplified active state setting
                };
                updateActiveState('sidebar-nav-pc');
                updateActiveState('sidebar-nav-mobile');

                contentArea.innerHTML = module.content(isAuthReady);
                document.getElementById('main-scroll').scrollTop = 0;
                
                if (id === 'cosmetic_acupuncture' && app.userId) {
                    loadStudyData(app.userId, 'funamizu_biyoushin');
                }
            }
        };

        // --- Firebase Init ---
        if (firebaseConfig) {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);
            
            onAuthStateChanged(auth, async (user) => {
                let currentUserId;
                if (user) {
                    currentUserId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        currentUserId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Firebase Sign-In failed:", error);
                        currentUserId = 'anonymous-' + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15));
                    }
                }
                app.userId = currentUserId;
                isAuthReady = true;
                
                const pcUserDisplay = document.getElementById('user-id-pc');
                if (pcUserDisplay) pcUserDisplay.textContent = 'Authenticated';
                
                app.loadModule(app.currentModule);
                if (app.currentModule === 'cosmetic_acupuncture') {
                     loadStudyData(app.userId, 'funamizu_biyoushin');
                }
            });
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>