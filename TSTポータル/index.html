<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>船水式鍼灸臨床学習ナビゲーター</title>
    <meta name="robots" content="noindex">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Orange/Gentle Theme: Primary(Deep Rust), Accent(Gold), Light(Warm White)
                        brand: { primary: '#B45309', accent: '#F59E0B', light: '#FFFDF6' },
                        // Rank colors adjusted to warmer tones
                        rank: { technical: '#9D5D1D', eastern: '#0F172A', specialty: '#F59E0B', mental: '#CA8A04' }
                    },
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #FFFDF6; /* New warm background */
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        .note-section textarea { font-family: 'Noto Sans JP', sans-serif; }
        .checklist-item { @apply bg-white p-3 border border-gray-200 rounded-lg transition-colors hover:bg-gray-50 cursor-pointer; }
        .checklist-item input[type="checkbox"] { 
            @apply accent-brand-primary; /* Use the deep orange primary color */
        }
        
        .welcome-card { 
            /* Golden gradient card for soft, luxurious feel */
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            border: 4px solid #B45309; 
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-brand-light">

    <aside class="w-72 bg-white border-r border-gray-200 flex-none flex flex-col z-20 shadow-xl">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-xl font-black text-brand-primary tracking-tight">船水式鍼灸 <span class="text-brand-accent">APP</span></h1>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">臨床学習ナビゲーター</p>
        </div>
        <div class="flex-1 overflow-y-auto p-3 custom-scroll sidebar-nav" id="sidebar-nav"></div>
        <footer class="p-4 text-center text-xs text-gray-400 border-t">
            <p>User ID: <span id="user-id">loading...</span></p>
            <script>document.getElementById('user-id').textContent = typeof __initial_auth_token !== 'undefined' ? 'Authenticated' : 'Anonymous';</script>
        </footer>
    </aside>

    <main class="flex-1 relative bg-brand-light flex flex-col min-w-0">
        <div class="flex-1 overflow-y-auto custom-scroll p-8 md:p-12" id="main-scroll">
            <article id="module-content" class="max-w-4xl mx-auto pb-32">
                <!-- Module content will be injected here -->
            </article>
        </div>
    </main>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Setup Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;
        const COLLECTION_PATH = `artifacts/${appId}/users/`;

        // --- Utility Functions for Firebase/UI (Helper functions) ---
        
        function getDocumentRef(userId, courseId) {
            if (!isAuthReady) return null;
            return doc(db, COLLECTION_PATH + userId + '/study_data', courseId);
        }

        async function saveStudyData(userId, courseId) {
            if (!isAuthReady) return;
            
            const docRef = getDocumentRef(userId, courseId);
            if (!docRef) return;

            const checklistContainer = document.getElementById('checklist-container');
            const notesTextarea = document.getElementById('notes');
            
            const studyData = { checklists: {}, notes: notesTextarea ? notesTextarea.value : "" };
            
            if (checklistContainer) {
                checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    const step = checkbox.closest('.checklist-item').dataset.step;
                    studyData.checklists[step] = checkbox.checked;
                });
            }

            try {
                await setDoc(docRef, studyData, { merge: true });
                // console.log(`Study data for ${courseId} saved.`);
                updateTotalScore();
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }

        function loadStudyData(userId, courseId) {
            if (!isAuthReady) {
                console.error("Auth not ready, cannot load data.");
                return;
            }

            const docRef = getDocumentRef(userId, courseId);
            if (!docRef) return;
            
            const checklistContainer = document.getElementById('checklist-container');
            const notesTextarea = document.getElementById('notes');
            
            // Set up event listeners unique to the currently loaded courseId
            if (checklistContainer) {
                checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false; // Initial UI reset
                    checkbox.onchange = () => { saveStudyData(userId, courseId); updateTotalScore(); };
                });
            }
            if (notesTextarea) {
                notesTextarea.value = ""; // Initial UI reset
                notesTextarea.oninput = () => saveStudyData(userId, courseId);
            }

            // Real-time listener
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    
                    if (loadedData.checklists && checklistContainer) {
                        checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                            const step = checkbox.closest('.checklist-item').dataset.step;
                            if (loadedData.checklists[step] !== undefined) {
                                checkbox.checked = loadedData.checklists[step];
                            }
                        });
                    }
                    
                    if (loadedData.notes !== undefined && notesTextarea) {
                        notesTextarea.value = loadedData.notes;
                    }
                    updateTotalScore();
                } else {
                    updateTotalScore();
                }
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }
        
        function updateTotalScore() {
            const checklistContainer = document.getElementById('checklist-container');
            if (!checklistContainer) return;
            
            const checkboxes = checklistContainer.querySelectorAll('input[type="checkbox"]');
            const totalSteps = checkboxes.length;
            const completedSteps = Array.from(checkboxes).filter(cb => cb.checked).length;

            const scoreText = `${completedSteps} / ${totalSteps} 完了`;
            const scorePercent = totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;
            
            const scoreElement = document.getElementById('total-score');
            if (scoreElement) scoreElement.textContent = scoreText;
            
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${scorePercent}%`;
                progressBar.setAttribute('aria-valuenow', completedSteps);
                progressBar.setAttribute('aria-valuemax', totalSteps);
            }
        }
        
        // --- Application Data and Core Logic (app object) ---
        const app = {
            userId: null,
            modules: {
                'welcome_dashboard': {
                    title: 'ようこそ',
                    icon: 'home-outline',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <div class="welcome-card p-8 md:p-12 text-brand-primary">
                            <div class="flex items-center space-x-4 mb-6">
                                <ion-icon name="sparkles" class="text-6xl text-brand-accent"></ion-icon>
                                <h2 class="text-4xl font-black tracking-tight">船水式鍼灸学 APP</h2>
                            </div>
                            <p class="text-xl font-semibold mb-8">CMCの技術と哲学を統合した、美容・臨床学習ナビゲーターです。</p>

                            <h3 class="text-2xl font-bold mb-4 flex items-center text-rank-technical">
                                <ion-icon name="bulb-outline" class="mr-3 text-3xl"></ion-icon> 船水式臨床の核
                            </h3>
                            <ul class="list-disc pl-8 space-y-3 text-lg mb-10">
                                <li><strong>TST（てい鍼術）:</strong> 刺さない鍼で<strong>気血を動かす</strong>。メンタルケア、難治性疾患に効果的です。</li>
                                <li><strong>コラーゲン戦略:</strong> 美容鍼の成功は、単なる刺鍼ではなく、40代以降に減少する<strong>コラーゲンとSMAS</strong>へのアプローチ、及び<strong>全身の陰陽調整</strong>にかかっています。</li>
                                <li><strong>三位一体治療:</strong> 局所（美容・筋骨格）の治療と、全身の<strong>経絡調整（本治法）</strong>、そして<strong>自律神経/内科的所見</strong>の改善を統合します。</li>
                            </ul>
                            
                            <div class="grid md:grid-cols-2 gap-6 text-base">
                                <div class="p-4 bg-white rounded-lg shadow-md border border-gray-100">
                                    <h4 class="font-bold text-xl mb-2 text-rank-specialty flex items-center"><ion-icon name="stats-chart-outline" class="mr-2"></ion-icon>美容鍼 技術習得目標</h4>
                                    <p>チェックリストで実践と知識を記録しましょう。</p>
                                    <ul class="mt-2 text-gray-700 space-y-1">
                                        <li>✅ 正確な<strong>23本刺鍼</strong>と<strong>安全性</strong>の確保。</li>
                                        <li>✅ <strong>SMAS</strong>や<strong>リガメント</strong>への解剖学的理解。</li>
                                        <li>✅ <strong>TST（てい鍼）</strong>による刺鍼前ケアの習得。</li>
                                    </ul>
                                </div>
                                <div class="p-4 bg-white rounded-lg shadow-md border border-gray-100">
                                    <h4 class="font-bold text-xl mb-2 text-rank-technical flex items-center"><ion-icon name="school-outline" class="mr-2"></ion-icon>本日の学習テーマ</h4>
                                    <p>ナビゲーションからモジュールを選択してください。</p>
                                    <ul class="mt-2 text-gray-700 space-y-1">
                                        <li>📌 <strong>TST基礎:</strong> 気の考え方、波紋術・さざなみ術の使い分け。</li>
                                        <li>📌 <strong>自律神経プロトコル:</strong> 陰陽失調タイプ別の調整法。</li>
                                        <li>📌 <strong>専門治療:</strong> 頸・肩・腰の低周波パルス応用。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `
                },
                'tst_basis': {
                    title: 'TST（てい鍼）の基礎',
                    icon: 'sparkles-outline',
                    color: 'eastern',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">てい鍼（TST）の基本理論と術式</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-eastern rounded mb-6 text-sm">
                            <h4 class="font-bold text-lg text-rank-eastern mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>TSTの目的</h4>
                            <p>てい鍼（錕鍼：刺さない鍼）を用いた<B>TAKAHIRO STYLE TECHNIQUE</B>は、<B>気血を動かすこと</B>を目的とし、刺激はごく少なく、経絡・経穴に触れる程度で行います。メンタルヘルスケアに特に効果が期待されています。</p>
                            <h4 class="font-bold text-lg text-rank-eastern mt-4 mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>気の考え方</h4>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>気と水:</strong> 水に関係する経穴（合谷、太渓、尺沢など）は気と関係が深い。</li>
                                <li><strong>経穴:</strong> 気が骨に当たり吹き出すところ（骨間部、脈の拍動部などに多い）。${isAuthReady ? '' : ''}</li>
                                <li><strong>気の流れ:</strong> コマに例えられるように、気の流れが滞ると安定性（静止）を失う。治療は気の流れが止まらないようにすること。${isAuthReady ? '' : ''}</li>
                                <li><strong>気の巡り:</strong> 気はスパイラル（渦巻き状）で巡る。</li>
                            </ul>
                            <h4 class="font-bold text-lg text-rank-eastern mt-4 mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>守破離と真行草</h4>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>守破離:</strong> 守（純粋に真似る）→ 破（型を創意工夫し一段上がる）→ 離（自分とは何か、道を作る）。</li>
                                <li><strong>真行草:</strong> 真（忠実に真似、動作の意味を知る）→ 行（柔軟な理解、状況に応じて変化）→ 草（全てを削ぎ落とした最も核心に近いもの）。</li>
                            </ul>
                        </div>
                         <h3 class="text-xl font-bold text-rank-eastern border-b border-gray-200 pb-2 mb-4">TST 術式分類（補法と瀉法）</h3>
                            <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg overflow-hidden mt-2 text-sm">
                                <thead>
                                    <tr class="bg-rank-eastern/10 font-bold">
                                        <th class="p-3 border">補瀉</th>
                                        <th class="p-3 border">分類</th>
                                        <th class="p-3 border">術式（例）</th>
                                        <th class="p-3 border">目的/イメージ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td class="p-3 border text-green-700 font-semibold" rowspan="4"><b>補法</b><br>(気を注ぐ)</td><td class="p-3 border" rowspan="2">基本</td><td class="p-3 border">波紋術、片手波紋術</td><td class="p-3 border">気が広がり、垂直に伝わる。水面に石を投げるイメージ。${isAuthReady ? '' : ''}</td></tr>
                                    <tr><td class="p-3 border">花火術、水琴窟術</td><td class="p-3 border">気を注ぎ、高める。臍や頭部など中心的な部位に。</td></tr>
                                    <tr><td class="p-3 border" rowspan="2">応用</td><td class="p-3 border">五月雨術</td><td class="p-3 border">優しくトントンと気を注ぐ。お母さんが背中を叩くイメージ。</td></tr>
                                    <tr><td class="p-3 border">稜線</td><td class="p-3 border">二本のてい鍼で深いところに気を通す（例: 頸部の深い筋）。</td></tr>
                                    <tr><td class="p-3 border text-red-700 font-semibold" rowspan="3"><b>瀉法</b><br>(気を流す)</td><td class="p-3 border" rowspan="3">基本/応用</td><td class="p-3 border">さざなみ術、両手さざなみ術</td><td class="p-3 border">経絡や体表面に気を流す。優しく撫でるイメージ。</td></tr>
                                    <tr><td class="p-3 border">霰（あられ）術</td><td class="p-3 border">五月雨術より弱い刺激。軽度の気の停滞を流す。</td></tr>
                                    <tr><td class="p-3 border">雷（いかづち）</td><td class="p-3 border">深部に気が伝わるような強い瀉法（例: 頚部の深部）。</td></tr>
                                </tbody>
                            </table>
                    `
                },
                'basic_pulse': {
                    title: '低周波治療の基礎',
                    icon: 'flash-outline',
                    color: 'technical',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">低周波鍼治療の基礎と設定</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-brand-accent rounded mb-6 text-sm">
                            <h4 class="font-bold text-lg text-brand-accent mb-2 flex items-center"><ion-icon name="alert-circle-outline" class="mr-2"></ion-icon>疼痛発生のメカニズム</h4>
                            <p>筋肉の緊張・自律神経の乱れにより血管が圧迫され血流が悪化。必要な酸素・栄養素が行き届かず、老廃物（疲労物質）が蓄積され、凝りや痛みが起こります。このメカニズムは血行不良改善、筋緊張緩和、疼痛緩和という低周波治療の3つの目的に直結します。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-lg text-brand-accent mt-4 mb-2 flex items-center"><ion-icon name="analytics-outline" class="mr-2"></ion-icon>筋ポンプ作用（血流改善の鍵）</h4>
                            <p>低頻度（1Hz〜10Hz）で筋肉を収縮させ、収縮後充血とポンプ作用を繰り返すことで、骨格筋内の循環を促進し、血流改善、筋緊張緩和、神経血流改善を行います。</p>
                        </div>

                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">周波数・パルス幅の使い分け</h3>
                        <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg overflow-hidden mb-6 text-sm">
                            <thead>
                                <tr class="bg-gray-100 font-bold">
                                    <th class="p-3 border">項目</th>
                                    <th class="p-3 border text-center"><b>一次痛・急性期</b><br>(損傷直後/鎮痛/腫脹)</th>
                                    <th class="p-3 border text-center"><b>二次痛・慢性期</b><br>(順応後/筋緩和/血流)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="p-3 border font-semibold">周波数</td><td class="p-3 border text-center">80〜125Hz (高頻度)</td><td class="p-3 border text-center">1〜30Hz (低頻度)</td></tr>
                                <tr><td class="p-3 border font-semibold">パルス幅</td><td class="p-3 border text-center">100µsec以下</td><td class="p-3 border text-center">100µsec以上 (深部アプローチ時は高めに)</td></tr>
                                <tr><td class="p-3 border font-semibold">通電時間</td><td class="p-3 border text-center">10分以上</td><td class="p-3 border text-center">20〜30分以上</td></tr>
                                <tr><td class="p-3 border font-semibold">刺激強度</td><td class="p-3 border text-center">反応閾値前後まで</td><td class="p-3 border text-center">反応閾値以下 (弱め)</td></tr>
                            </tbody>
                        </table>
                        
                        <h4 class="font-bold text-lg text-brand-accent mb-2">周波数別作用の目安</h4>
                        <ul class="list-disc pl-5 space-y-2 text-sm">
                            <li><strong>1〜3Hz (単収縮):</strong> 筋緊張緩和、筋ポンプ作用。通電15分程度。</li>
                            <li><strong>30〜60Hz (強縮):</strong> 筋疲労軽減、腱炎。通電15分程度。</li>
                            <li><strong>100〜120Hz (収縮なし):</strong> 関節痛、局所鎮痛、腫脹の軽減。通電15分程度。</li>
                            <li><strong>急性期の注意:</strong> 筋繊維断裂の恐れがあるため、筋ポンプを起こすような低頻度（1Hz〜10Hz）は避け、高頻度（収縮させない）を使用する。</li>
                        </ul>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-8 mb-4">経穴通電プロトコル（微弱電流）</h3>
                        <ul class="list-disc pl-5 space-y-2 text-sm">
                            <li><strong>基本設定:</strong> すべて <strong>1Hz / 10分</strong>、<strong>拍動を感じない程度の微弱電流</strong>（約0.01〜0.05mA）で行い、副交感神経を優位にし血行促進を目指す。</li>
                            <li><strong>応用部位:</strong> <ul>
                                <li><strong>胃腸/下肢:</strong> 足三里〜下巨虚（胃痛）、両天枢（IBS）。</li>
                                <li><strong>骨盤/ED/婦人科:</strong> 曲骨〜関元、子宮〜帰来。</li>
                                <li><strong>腰:</strong> 腎兪〜大腸兪、中封〜蠡溝（腰痛・むくみ）。</li>
                            </ul></li>
                             <li><strong>混合治療:</strong> ぎっくり腰など急性期損傷部位には1〜3Hzの微弱電流、離れた部位（起始/停止）には100Hzパルスで筋ポンプ作用をサポート。</li>
                        </ul>
                    `
                },
                'fem_care': {
                    title: '婦人科・フェムケアプロトコル',
                    icon: 'woman-outline',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">婦人科疾患の東洋医学的治療</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-specialty rounded mb-6 text-sm">
                            <h4 class="font-bold text-lg text-rank-specialty mb-2 flex items-center"><ion-icon name="body-outline" class="mr-2"></ion-icon>骨盤底筋群とインナーユニット</h4>
                            <p>骨盤底筋群は内臓（膀胱、子宮、直腸）を支える<strong>土台</strong>であり、横隔膜・腹横筋・多裂筋と共に<strong>インナーユニット</strong>を形成し、体幹の安定に不可欠です。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-lg text-rank-specialty mt-4 mb-2 flex items-center"><ion-icon name="alert-circle-outline" class="mr-2"></ion-icon>衰える原因と治療の方向性</h4>
                            <p><strong>衰える原因:</strong> 加齢（女性ホルモン減少）、妊娠・出産、慢性的な排便時のいきみ。<br><strong>治療の方向性:</strong> 骨盤底筋の筋力増強、大腿内転筋群（骨盤底筋を支える）のストレッチ、<strong>陰部神経（仙棘靭帯/梨状筋）</strong>へのアプローチによる神経刺激。</p>
                        </div>

                        <h3 class="text-xl font-bold text-rank-specialty border-b border-gray-200 pb-2 mb-4">経穴治療プロトコル</h3>
                        <h4 class="font-bold text-base mt-2 mb-2">共通穴（冷えと生命力の源を補う）</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm mb-4">
                            <li><strong>任脈系:</strong> <strong>石門</strong>、<strong>気海</strong>、<strong>関元</strong>（<strong>妊娠脈</strong>であり、妊娠エネルギーが流れる）を3mm/10分置鍼。</li>
                            <li><strong>子宮周囲:</strong> 子宮・帰来（子宮の栄養血管上）。低周波は<strong>1cm / 3Hz / 15分</strong>。生理痛時は<strong>100Hz</strong>。</li>
                            <li><strong>陰経の要穴:</strong> <strong>太渓</strong>（腎経原穴、生命力の源）、<strong>三陰交</strong>（3つの陰経の交わる冷えやすい場所）、<strong>血海</strong>（統血作用、血の循環）。</li>
                            <li><strong>背部:</strong> <strong>腎兪</strong>（腎気の充足、腰痛治療）・<strong>次醪</strong>（精子の活動能力UPのエビデンス）。</li>
                        </ul>
                        
                        <h3 class="text-xl font-bold text-rank-specialty border-b border-gray-200 pb-2 mt-8 mb-4">疾患タイプ別プロトコル</h3>
                        <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg overflow-hidden mb-6 text-sm">
                            <thead>
                                <tr class="bg-rank-specialty/10 font-bold">
                                    <th class="p-3 border">タイプ</th>
                                    <th class="p-3 border">病態（東洋医学的根拠）</th>
                                    <th class="p-3 border">使用経穴（手技）</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="p-3 border font-semibold">気滞瘀血タイプ</td>
                                    <td class="p-3 border">気の巡り/血の巡りが悪く瘀血が形成。月経時、塊が出た後に痛みが軽減するタイプ。</td>
                                    <td class="p-3 border"><strong>血海</strong>・<strong>三陰交</strong>（陰陵泉）に<strong>マイクロカレント</strong>。<br><strong>気海</strong>・<strong>曲泉</strong>（疏泄・活血作用）。</td>
                                </tr>
                                <tr>
                                    <td class="p-3 border font-semibold">熱がこもりやすタイプ</td>
                                    <td class="p-3 border">陰虚熱、月経時ホットフラッシュ/盗汗。肝の**疎泄**作用低下によるイライラや自律神経の乱れ。</td>
                                    <td class="p-3 border"><strong>太衝</strong>・<strong>蠡溝</strong>に<strong>マイクロカレント</strong>（肝の調整）。<br><strong>三陰交</strong>（熱を抑える）。</td>
                                </tr>
                                <tr>
                                    <td class="p-3 border font-semibold">冷えが強いタイプ</td>
                                    <td class="p-3 border">肝虚・腎虚、下腹部の冷え（腎陽虚）が強く、下肢のむくみを伴う。脾経の**昇清**作用低下。</td>
                                    <td class="p-3 border"><strong>中極</strong>・<strong>関元</strong>・<strong>三陰交</strong>に<strong>灸</strong>。<br>地機、水道。復溜に置鍼（3mm/10分）。</td>
                                </tr>
                            </tbody>
                        </table>
                        <h4 class="font-bold text-lg text-brand-accent mb-2">その他 東洋医学的治療経絡</h4>
                         <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li><strong>脾経（統血/昇清）:</strong> 公孫・三陰交・陰陵泉・血海（出血、子宮脱、湿熱対策）。</li>
                            <li><strong>肝経（疏泄）:</strong> 太衝・中封・蠡溝（疏泄作用低下、瘀血による生理痛対策）。</li>
                            <li><strong>腎経（水の流れ/陰虚）:</strong> 太渓・復溜・大赫・充府（水の流れ、疲労、陰虚対策）。</li>
                             <li><strong>TST（てい鍼）:</strong> 臍に花火術、仙骨部に波紋術など（深部温め）。</li>
                        </ul>
                    `
                },
                'autonomic_nervous_system': {
                    title: '自律神経治療プロトコル',
                    icon: 'brain-outline',
                    color: 'mental',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">自律神経失調症と陰陽調整</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-mental rounded mb-6 text-sm">
                            <h4 class="font-bold text-lg text-rank-mental mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>自律神経の役割と病態</h4>
                            <p>自律神経（交感/副交感）は、日中は交感神経が優位、夜間は副交感神経が優位となる理想的なリズムで臓器をコントロールします。バランスが崩れると、頭痛、動悸、冷え、しびれなど全身に様々な不調（自律神経失調症）が現れます。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-lg text-rank-mental mt-4 mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>陰陽失調タイプ（病態生理）</h4>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>陰気が多すぎる:</strong> 動き・発言が鈍り、心身ともに冷え、優柔不断、依存体質。冷え性、低血圧、寝起きが悪い。（腎陽虚・脾虚寒の傾向）</li>
                                <li><strong>陽気が多すぎる:</strong> 体温上昇、のぼせ、イライラ、頑固、協調性がなく、口数が多く早口。心拍数/血圧が高い。（肝陽亢進・陰虚熱の傾向）</li>
                                <li><strong>自律神経失調の治療戦略:</strong> 東洋医学的治療（陰陽調整）が効果的。全身血流を高め（副交感神経優位）、胸郭・頭部血流を改善（視床下部調整）する。パルス療法は弱刺激で行う。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-mental border-b border-gray-200 pb-2 mb-4">東洋医学的治療プロトコル（QOL・精神安定）</h3>
                        <p class="text-sm mb-4">陰陽の調整を基本とし、QOL改善と精神安定を目指します。全ての処方は3mm/10分置鍼が基本です。</p>
                        
                        <h4 class="font-bold text-base mt-2 mb-2">主要経穴（毫鍼・置鍼）</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li><strong>腹部（陰陽調整/脾胃）:</strong> <strong>中脘</strong>・<strong>関元</strong>・<strong>天枢</strong>（脾胃の気血生成を促進し、全身の陽気を調整）。</li>
                            <li><strong>自律神経調節:</strong> <strong>内関</strong>（心包/自律神経）、<strong>外関</strong>（三焦系/体温・免疫力）。</li>
                            <li><strong>腎（生命力/体温）:</strong> <strong>太渓</strong>、背部<strong>腎兪</strong>・<strong>志室</strong>。</li>
                            <li><strong>背部/頸部（陽気調整）:</strong> 膈兪・肝兪・脾兪腎兪（背部兪穴）、<strong>天柱</strong>・<strong>風池</strong>（頸部の気の流れを改善）。</li>
                        </ul>
                         <h4 class="font-bold text-base mt-4 mb-2">TST応用（てい鍼/刺さない鍼）</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            <li><strong>胸部:</strong> <strong>膻中</strong>（即刺即抜）で胸郭の緊張を緩め、呼吸を楽にする。</li>
                            <li><strong>頭部:</strong> 頭部散鍼（<strong>百会</strong>、<strong>額会</strong>、<strong>冠状縫合</strong>）で頭部血流を改善。<strong>額</strong>のつまみ触察後、20Hzパルスで頭部血流改善。</li>
                            <li><strong>耳鍼:</strong> <strong>神門</strong>（精神安定/痛み）、<strong>BFA</strong>（視床、帯状回など脳中枢に作用）。${isAuthReady ? '' : ''}</li>
                        </ul>
                    `
                },
                'knee_shoulder_trunk': {
                    title: '膝・体幹・肩の専門治療',
                    icon: 'pulse-outline',
                    color: 'technical',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">膝関節疾患の治療プロトコル</h2>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">1. 鵞足炎（Pes Anserine Bursitis）</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <p><strong>痛みの部位:</strong> 膝内側。鵞足部（縫工筋・薄筋・半腱様筋の腱付着部）。<strong>原因:</strong> オーバーユースによる膝の屈曲・股関節内転動作の繰り返し。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-base mt-2">鍼治療プロトコル</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>主刺鍼部位:</strong> <strong>薄筋</strong>（神経・血管網が多く、最も痛みを及ぼしやすい）</li>
                                <li><strong>周波数:</strong> 通常 5Hz / 15分。痛みが強い場合は 100Hz（急性期の鎮痛）。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">2. 腸脛靭帯炎（ITBS / Runner's Knee）</h3>
                         <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <p><strong>痛みの部位:</strong> 膝外側面。大腿骨外側上顆付近。<strong>原因:</strong> 腸脛靭帯が大腿骨外側上顆を擦過することで炎症が起こる。${isAuthReady ? '' : ''}</p>
                            <h4 class="font-bold text-base mt-2">鍼治療プロトコル</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>主刺鍼部位:</strong> 膝付近の<strong>腸脛靭帯外側縁</strong>、または<strong>大腿筋膜張筋</strong>。</li>
                                <li><strong>補助穴:</strong> 長腓骨筋部位 (<strong>陽陵泉</strong>、<strong>陽交</strong>など) に刺鍼すると更に効果的。</li>
                                <li><strong>遠隔治療（陽経を動かす）:</strong> <strong>条口</strong>〜<strong>承山</strong>への透刺（条山治療）。2寸3〜5番鍼で2cm以上刺入し、陽経の気血循環を促進。</li>
                            </ul>
                        </div>

                        <h2 class="text-2xl font-black text-brand-primary mt-10 mb-6">体幹・肩の専門低周波パルス</h2>

                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mb-4">1. 多裂筋/腰方形筋低周波通電療法</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">多裂筋（固定性/中心部の痛み）</h4>
                            <ul class="list-disc pl-5 mb-2">
                                <li><strong>特徴:</strong> 脊椎の安定に重要。腰痛患者の約80%に萎縮。腰の中心の痛み。</li>
                                <li><strong>目的:</strong> 筋収縮させて力を戻したい時：<strong>5Hz〜8Hz</strong>。痛みを取る：<strong>1Hz〜2Hz</strong>で微弱電流。急性期は50〜100Hz。</li>
                                <li><strong>刺鍼:</strong> L4棘突起すぐ横を押圧し、脚挙上や力で硬くなる部位を確認。</li>
                            </ul>
                            <h4 class="font-bold text-base mt-2 mb-2">腰方形筋（深部の刺すような痛み）</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>特徴:</strong> 12肋骨に付着し呼吸と関与。奥深くに刺すような痛み、寝返り時痛。</li>
                                <li><strong>刺鍼部位:</strong> 腰椎棘突起の外方3〜5cmのエリア。<strong>垂直に40mm/16号で5〜10mm刺入</strong>。</li>
                                <li><strong>注意:</strong> 大腰筋刺鍼時は深さ6cm（L3・4横突起に直刺）。<strong>5cmで腎臓に到達するリスク</strong>があるため厳重に注意。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">2. 頸部・斜角筋パルス鍼</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">斜角筋パルス（TOS/スマホ姿勢）</h4>
                            <ul class="list-disc pl-5 mb-2">
                                <li><strong>部位:</strong> 胸鎖乳突筋（SCM）後縁。<strong>喉頭隆起の高さ以下は気胸リスクあり</strong>。SCM後縁に縦に2本を皮膚に垂直に刺鍼（深さ1cm）。</li>
                                <li><strong>目的/周波数:</strong> <strong>1Hz〜2Hz</strong> / 15分。強いしびれが出ない程度のボリューム。SCMの収縮は避ける。</li>
                            </ul>
                            <h4 class="font-bold text-base mt-2 mb-2">横隔神経刺鍼（呼吸調整）</h4>
                            <ul class="list-disc pl-5">
                                <li><strong>部位:</strong> 喉頭隆起ライン。SCM鎖骨頭を指で押し下げて刺鍼（1cm以下）。針先は<strong>前斜角筋</strong>に触れるように。</li>
                                <li><strong>注意:</strong> 深く指すと腕神経叢に当たり不快なピリピリ感が出る。横隔膜の運動を支配する神経であり、呼吸の改善に直結。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">3. 肩の専門治療（ローテータカフ・巻き肩）</h3>
                        <div class="bg-brand-light p-4 rounded mb-4 text-sm">
                            <h4 class="font-bold text-base mt-2 mb-2">棘上筋/肩甲上神経パルス（外転障害）</h4>
                            <ul class="list-disc pl-5 mb-2">
                                <li><strong>筋パルス:</strong> 棘上筋に水平に2穴刺入（1cm）。1〜3Hzで筋収縮をしっかり確認。</li>
                                <li><strong>神経パルス:</strong> <strong>肩甲上神経</strong>（肩甲切痕、棘下切痕）に1Hz / 15分。筋が心地よく動くレベル。</li>
                                <li><strong>肩甲挙筋:</strong> 乳様突起付近やC4横突起付近。上角付近は<strong>肺尖部</strong>に注意（てい鍼・散鍼が有効）。</li>
                            </ul>
                             <h4 class="font-bold text-base mt-2 mb-2">巻き肩/大円筋/小円筋（結髪結帯障害）</h4>
                             <ul class="list-disc pl-5">
                                <li><strong>巻き肩原因筋:</strong> 肩甲挙筋、僧帽筋上部線維、大胸筋、<strong>大円筋</strong>。</li>
                                <li><strong>大円筋刺鍼:</strong> 肩甲骨下角付近で内旋し収縮する部位に直刺1〜2cm。</li>
                                <li><strong>小円筋刺鍼:</strong> 肩甲骨に沿って刺鍼し、大結節付近に直刺（深さ1〜2cm）。小円筋は<strong>腋窩神経</strong>支配。</li>
                                 <li><strong>QLS（四辺形間隙）:</strong> 小円筋、大円筋、上腕三頭筋長頭、上腕骨で構成され、腋窩神経/後上腕回旋動脈が通る。過緊張でしびれ・痛みが発生。</li>
                            </ul>
                        </div>
                    `
                },
                'keiraku_chiryo': {
                    title: '東洋医学・経絡治療の基本',
                    icon: 'leaf-outline',
                    color: 'eastern',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">『増補改訂版 日本鍼灸医学』の核心</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-eastern rounded mb-6 text-sm">
                            <p>経絡治療は、古典理論に基づき、すべての疾病を<strong>経絡の虚実状態</strong>として把握し、それを鍼灸を用いて調整（補瀉）する<strong>随証療法</strong>です。病気の始まりは<strong>五臓の精気の虚</strong>からと考えます。</p>
                            <h4 class="font-bold text-lg text-rank-eastern mt-2 mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>診断の基本</h4>
                            <ul class="list-disc pl-5 space-y-1">
                                <li><strong>四診法:</strong> 望診、聞診、問診、切診（脈診、腹診、切経）。</li>
                                <li><strong>最重要: 切診（特に脈診）</strong>。六部定位脈診により、臓腑経絡における気血津液の虚実寒熱を診察します。</li>
                                <li><strong>虚実:</strong> 虚（あるべきものがない）を補い、実（あってはいけないものがある）を瀉すのが原則。</li>
                            </ul>
                            <h4 class="font-bold text-lg text-rank-eastern mt-4 mb-2 flex items-center"><ion-icon name="caret-forward-outline" class="mr-2"></ion-icon>治療の基本（本治法と標治法）</h4>
                             <ul class="list-disc pl-5 space-y-1">
                                <li><strong>本治法:</strong> 精気の虚（肝虚、脾虚、肺虚、腎虚）を補うこと。五行穴（五兪穴）が主に使用されます。</li>
                                <li><strong>標治法:</strong> 寒熱が波及した局所（患者の主訴部）の虚実、寒熱に対して行う補瀉。</li>
                                <li><strong>補瀉の原則:</strong> 『難経』六十九難に基づく<strong>「虚すればその母を補い、実すればその子を潟す」</strong>が基本原則です。</li>
                            </ul>
                        </div>
                        
                        <h3 class="text-xl font-bold text-rank-eastern border-b border-gray-200 pb-2 mb-4">五行説と五臓の関連（相生関係）</h3>
                        <table class="w-full text-left table-auto border-collapse border border-gray-300 rounded-lg overflow-hidden mb-6 text-sm">
                            <thead>
                                <tr class="bg-rank-eastern/10 font-bold">
                                    <th class="p-3 border">五行</th>
                                    <th class="p-3 border">五臓（母）</th>
                                    <th class="p-3 border">五臓（子）</th>
                                    <th class="p-3 border">関係性</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="p-3 border">水</td><td class="p-3 border">腎（精を蔵す）</td><td class="p-3 border">肝（血を潤す）</td><td class="p-3 border">腎は肝を生ず</td></tr>
                                <tr><td class="p-3 border">木</td><td class="p-3 border">肝（血を蔵す）</td><td class="p-3 border">心（心の活動の元）</td><td class="p-3 border">肝は心を生ず</td></tr>
                                <tr><td class="p-3 border">火</td><td class="p-3 border">心（陽気を発揮）</td><td class="p-3 border">脾（陽気を受け働く）</td><td class="p-3 border">心は脾を生ず</td></tr>
                                <tr><td class="p-3 border">土</td><td class="p-3 border">脾（気血津液を生成）</td><td class="p-3 border">肺（肺気の循環を助ける）</td><td class="p-3 border">脾は肺を生ず</td></tr>
                                <tr><td class="p-3 border">金</td><td class="p-3 border">肺（気を全身に送る）</td><td class="p-3 border">腎（津液を全身に巡らせる）</td><td class="p-3 border">肺は腎を生ず</td></tr>
                            </tbody>
                        </table>
                        <p class="text-xs text-gray-500">※治療では、この相生関係に基づき、虚している経（母）の補うべき穴を選びます。</p>
                    `
                },
                'cosmetic_acupuncture': {
                    title: '船水式美容鍼チェックリスト',
                    icon: 'clipboard-outline',
                    color: 'specialty',
                    content: (isAuthReady) => `
                        <h2 class="text-2xl font-black text-brand-primary mb-6">船水式美容鍼（基本）実技チェックリスト</h2>
                        <div class="bg-brand-light p-4 border-l-4 border-rank-specialty rounded mb-6 text-sm">
                            <p><strong>コースID:</strong> funamizu_biyoushin</p>
                            <h4 class="font-bold text-lg text-rank-specialty mb-2 flex items-center"><ion-icon name="list-circle-outline" class="mr-2"></ion-icon>進捗状況</h4>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-bold text-brand-primary">完了ステップ:</span>
                                <span id="total-score" class="text-2xl font-black text-brand-accent">0 / 22 完了</span>
                            </div>
                            <div class="progress-bar-container w-full h-2 bg-gray-200 rounded-full">
                                <div id="progress-bar" class="h-full bg-rank-specialty rounded-full transition-all duration-400" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="22" style="width: 0%;"></div>
                            </div>
                        </div>

                        <div id="checklist-container">
                            <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-4 mb-4">I. 基本手技・解剖・安全性チェック (必須)</h3>
                            <div class="checklist-item" data-step="p1_prep_talk">
                                <label><input type="checkbox"><span>1. 術前説明とコラーゲン知識</span></label>
                                <div class="step-detail">効果、術後の注意点、<strong>コラーゲンが40代以降減少</strong>、ターンオーバー（45日）の説明が正確。</div>
                            </div>
                            <div class="checklist-item" data-step="p2_base_clean">
                                <label><input type="checkbox"><span>2. 消毒、前後揉捻、皮膚触察の実施</span></label>
                                <div class="step-detail">術者・患者の消毒、前後揉捻、肌の状態（弾力/乾燥）の触察。</div>
                            </div>
                            <div class="checklist-item" data-step="p3_hishin_safety">
                                <label><input type="checkbox"><span>3. 基本刺鍼（23本）の正確性と安全性</span></label>
                                <div class="step-detail">切皮痛がなく、正しい角度・押手で基本23本のポイントに刺鍼。（611. キュア式美容鍼 基本）</div>
                            </div>
                            <div class="checklist-item" data-step="p4_artery_nerve">
                                <label><input type="checkbox"><span>4. 顔面動脈・神経走行の理解と回避</span></label>
                                <div class="step-detail">外頚動脈の分枝や顔面神経の走行（側頭枝、頬骨枝など）を理解し、内出血・神経損傷を回避できた。</div>
                            </div>
                            <div class="checklist-item" data-step="p5_basic_safety_time">
                                <label><input type="checkbox"><span>5. 時間管理と安心感（5分以内）</span></label>
                                <div class="step-detail">弾入、刺入、抜鍼が安全にでき、時間内（5分以内）に施術を完了する。終始、安心感のある対応。</div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">II. 部位別・解剖チェック（SMAS・リガメントへのアプローチ）</h3>
                            <div class="checklist-item" data-step="p6_tst_facecare">
                                <label><input type="checkbox"><span>6. TST（てい鍼）を用いた刺鍼前ケア実施</span></label>
                                <div class="step-detail">頸部回旋確認後、TST（波紋術・さざなみ術など）を用いて、刺鍼前ケアを実施。</div>
                            </div>
                            <div class="checklist-item" data-step="p7_part_eye_lig">
                                <label><input type="checkbox"><span>7. 目元（眼輪筋、皺眉筋）とリガメントへのアプローチ</span></label>
                                <div class="step-detail">目周りのたるみやシワの原因となる眼輪筋、皺眉筋への施術。ティアトラフなどのリガメントポイントを意識。</div>
                            </div>
                            <div class="checklist-item" data-step="p8_part_nose">
                                <label><input type="checkbox"><span>8. 鼻（鼻根筋、鼻筋）へのアプローチと効果</span></label>
                                <div class="step-detail">鼻根筋、鼻筋を意識した施術。鼻の通りや血色への変化を確認。</div>
                            </div>
                            <div class="checklist-item" data-step="p9_part_mouth_smas">
                                <label><input type="checkbox"><span>9. 口元・法令線（口輪筋、SMAS）へのアプローチ</span></label>
                                <div class="step-detail">口輪筋、口角挙筋の施術。法令線周辺のSMAS（表在性筋膜）への引き上げと連携を意識。</div>
                            </div>
                            <div class="checklist-item" data-step="p10_part_cheek_jaw">
                                <label><input type="checkbox"><span>10. 頬・輪郭（大頬骨筋、広頸筋）へのアプローチ</span></label>
                                <div class="step-detail">頬骨筋、広頸筋へのアプローチ。輪郭の引き上げと、顎下から首にかけてのたるみへの施術。</div>
                            </div>
                            <div class="checklist-item" data-step="p11_part_lymph">
                                <label><input type="checkbox"><span>11. リンパ・血流の促進とエチケット</span></label>
                                <div class="step-detail">顔面部のリンパドレナージュ（耳下腺、頸部）を行い、血流を改善。触り方、手つきに配慮。</div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">III. 症状別チェック（効果の再現性・東洋医学的所見）</h3>
                            <div class="checklist-item" data-step="p12_symptom_lift">
                                <label><input type="checkbox"><span>12. たるみ・リフトアップの改善確認</span></label>
                                <div class="step-detail">施術後に顎下のラインや頬の位置が改善されたことを鏡で確認。</div>
                            </div>
                             <div class="checklist-item" data-step="p13_symptom_circulation">
                                <label><input type="checkbox"><span>13. 血色・くすみ・疲労感の改善確認</span></label>
                                <div class="step-detail">施術後の顔の艶、血色（ワントーン明るい）、疲労感の軽減を確認。</div>
                            </div>
                             <div class="checklist-item" data-step="p14_symptom_skin_oath">
                                <label><input type="checkbox"><span>14. ニキビ・肌荒れへの東洋医学的アプローチ</span></label>
                                <div class="step-detail">ニキビ、肌荒れなどの病態（胃熱、脾虚熱など）を問診し、経絡治療と連携した美容鍼を選択。</div>
                            </div>
                             <div class="checklist-item" data-step="p15_symptom_tension">
                                <label><input type="checkbox"><span>15. 口元の緊張・歪み（食いしばり）の改善</span></label>
                                <div class="step-detail">咬筋・側頭筋へのアプローチを通じて、口元の緊張や食いしばりによる歪みを軽減できた。</div>
                            </div>
                             <div class="checklist-item" data-step="p16_body_balance_body">
                                <label><input type="checkbox"><span>16. 全身の本治法（経絡調整）の実施</span></label>
                                <div class="step-detail">全身の冷えや内科的所見（婦人科疾患など）に対する本治法経穴（太渓、三陰交、血海など）を選択し実施。</div>
                            </div>
                             <div class="checklist-item" data-step="p17_body_balance_oath">
                                <label><input type="checkbox"><span>17. 脈診/腹診による全身所見の前後確認</span></label>
                                <div class="step-detail">施術前後の脈診・腹診を行い、陰陽バランス（虚実）の変化を確認。</div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-rank-technical border-b border-gray-200 pb-2 mt-6 mb-4">IV. 応用・口頭試問（Diamond Class相当）</h3>
                            <div class="checklist-item" data-step="p18_advanced_pulse">
                                <label><input type="checkbox"><span>18. 顔面神経パルス（応用）の実施</span></label>
                                <div class="step-detail">顔面神経沿いに正確に刺鍼し、パルサー操作、本体・コードの安全性を確保する。（制限時間5分）</div>
                            </div>
                            <div class="checklist-item" data-step="p19_advanced_tst">
                                <label><input type="checkbox"><span>19. TST（てい鍼術式）の選択と実施</span></label>
                                <div class="step-detail">症状に応じて適切なTST術式（補瀉の使い分け）を実施。時間内（10分以内）に施術を完了。</div>
                            </div>
                            <div class="checklist-item" data-step="p20_advanced_kouto">
                                <label><input type="checkbox"><span>20. 口頭試問への対応（美容・解剖）</span></label>
                                <div class="step-detail">コラーゲン、エラスチン、ターンオーバー、ニキビなど、美容に関する口頭試問に全て答えられた。</div>
                            </div>
                            
                        </div>
                        
                        <section class="note-section mt-8">
                            <h3 class="text-xl font-bold text-brand-primary mb-4">練習メモ・気づき</h3>
                            <textarea id="notes" class="w-full p-3 border border-gray-300 rounded-lg min-h-[150px]" placeholder="今日の練習で気づいたこと、改善すべき点、患者さんへの説明で工夫したいことなどを記録しましょう。"></textarea>
                        </section>
                    `
                },
            },
            currentModule: 'welcome_dashboard', 
            
            init() {
                this.renderSidebar();
                this.loadModule(this.currentModule);
            },
            
            renderSidebar() {
                const container = document.getElementById('sidebar-nav');
                container.innerHTML = '';
                for (const id in this.modules) {
                    const module = app.modules[id]; 
                    const btn = document.createElement('button');
                    btn.id = `nav-${id}`;
                    btn.className = `w-full text-left px-4 py-3 mb-1 flex items-center transition-all duration-200 border-l-4 border-transparent text-gray-700 hover:bg-gray-100 hover:border-rank-${module.color}`;
                    btn.innerHTML = `<ion-icon name="${module.icon}" class="text-lg mr-3 text-rank-${module.color}"></ion-icon><span class="font-medium text-sm">${module.title}</span>`;
                    btn.onclick = () => app.loadModule(id); 
                    container.appendChild(btn);
                }
            },
            
            loadModule(id) {
                app.currentModule = id;
                const module = app.modules[id];
                const contentArea = document.getElementById('module-content');
                
                // Active nav state
                document.querySelectorAll('.sidebar-nav button').forEach(btn => {
                    // モジュールIDに関わらず、activeなクラスを全て削除
                    Object.values(app.modules).forEach(m => {
                        btn.classList.remove('bg-gray-200', `border-rank-${m.color}`, 'font-bold');
                    });
                });
                const activeBtn = document.getElementById(`nav-${id}`);
                if (activeBtn) activeBtn.classList.add('bg-gray-200', `border-rank-${module.color}`, 'font-bold');
                
                // Render content: 関数呼び出しにisAuthReadyフラグを渡す
                contentArea.innerHTML = module.content(isAuthReady);
                document.getElementById('main-scroll').scrollTop = 0;
                
                // Load Firebase data only if it's the checklist module AND Auth is ready
                if (id === 'cosmetic_acupuncture' && app.userId) {
                    loadStudyData(app.userId, 'funamizu_biyoushin'); // 常にこのIDでロード
                }
            }
        };

        // --- Firebase Initialization ---
        if (firebaseConfig) {
            const firebaseApp = initializeApp(firebaseConfig);
            db = getFirestore(firebaseApp);
            auth = getAuth(firebaseApp);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                let currentUserId;
                if (user) {
                    currentUserId = user.uid;
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        currentUserId = auth.currentUser.uid;
                    } catch (error) {
                        console.error("Firebase Sign-In failed:", error);
                        currentUserId = 'anonymous-' + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15));
                    }
                }
                app.userId = currentUserId;
                isAuthReady = true;
                
                // Auth完了後にモジュールを再ロードして動的コンテンツ(画像など)を更新
                app.loadModule(app.currentModule);
                
                // Load data if it's the checklist
                if (app.currentModule === 'cosmetic_acupuncture') {
                     loadStudyData(app.userId, 'funamizu_biyoushin');
                }
            });
        }
        
        // Ensure the application core starts when the DOM is fully loaded
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>